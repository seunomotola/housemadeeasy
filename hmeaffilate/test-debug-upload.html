<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug YouTube Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        #debugOutput { background: #f5f5f5; padding: 15px; border-radius: 5px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #005a87; }
        input[type="text"], textarea { width: 100%; padding: 8px; margin: 5px 0; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>YouTube Upload Debug Test</h1>
    
    <div class="section">
        <h2>Step 1: Google OAuth Authentication</h2>
        <p>First, authenticate with Google to get access token:</p>
        <button onclick="startOAuth()">Start OAuth Flow</button>
        <div id="oauthStatus"></div>
    </div>
    
    <div class="section">
        <h2>Step 2: Test Video Upload</h2>
        <p>Upload a video file to test the YouTube upload process:</p>
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="text" name="title" placeholder="Video Title" value="Test Video Upload">
            <textarea name="description" placeholder="Video Description">Test video upload from HouseMadeEasy debug</textarea>
            <input type="file" name="video" accept="video/*" required>
            <button type="button" onclick="testUpload()">Upload Video (Debug Mode)</button>
        </form>
    </div>
    
    <div class="section">
        <h2>Debug Output</h2>
        <div id="debugOutput">Debug output will appear here...</div>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('debugOutput').textContent = '';
        }

        function startOAuth() {
            clearLog();
            log('Starting OAuth flow...');
            
            // Redirect to Google OAuth
            const clientId = '488890072316-a367l4n2ns3l17o0unoab7jp9t4mgd52.apps.googleusercontent.com';
            const redirectUri = encodeURIComponent('https://housemadeeasy.com.ng/hmeaffilate/test-video-upload-debug.php');
            const scope = encodeURIComponent('https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/youtube.force-ssl');
            const state = encodeURIComponent('test-debug');
            
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${clientId}&` +
                `redirect_uri=${redirectUri}&` +
                `scope=${scope}&` +
                `response_type=code&` +
                `access_type=offline&` +
                `prompt=consent&` +
                `state=${state}`;
            
            window.location.href = authUrl;
        }

        async function testOAuth(code) {
            try {
                log('Testing OAuth with code: ' + code.substring(0, 20) + '...');
                
                const formData = new FormData();
                formData.append('action', 'test_oauth');
                
                const response = await fetch('test-video-upload-debug.php?code=' + encodeURIComponent(code), {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                log('OAuth Response: ' + JSON.stringify(result, null, 2));
                
                if (result.success) {
                    document.getElementById('oauthStatus').innerHTML = '<p class="success">✅ OAuth successful! Access token obtained.</p>';
                } else {
                    document.getElementById('oauthStatus').innerHTML = '<p class="error">❌ OAuth failed: ' + result.error + '</p>';
                }
                
            } catch (error) {
                log('OAuth test error: ' + error.message, 'error');
            }
        }

        async function testUpload() {
            clearLog();
            log('Starting video upload test...');
            
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);
            formData.append('action', 'test_upload');
            
            try {
                log('Uploading video...');
                
                const response = await fetch('test-video-upload-debug.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                log('Upload Response: ' + JSON.stringify(result, null, 2));
                
                if (result.success) {
                    log('✅ Upload successful!', 'success');
                    if (result.result && result.result.id) {
                        log('Video ID: ' + result.result.id, 'success');
                    }
                } else {
                    log('❌ Upload failed: ' + result.error, 'error');
                    if (result.debug) {
                        log('Debug info: ' + JSON.stringify(result.debug, null, 2), 'error');
                    }
                }
                
            } catch (error) {
                log('Upload test error: ' + error.message, 'error');
            }
        }

        // Check if we're returning from OAuth
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        
        if (code && state === 'test-debug') {
            log('Returned from OAuth with code');
            testOAuth(code);
        }
    </script>
</body>
</html>